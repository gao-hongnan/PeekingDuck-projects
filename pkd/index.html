
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://reighns92.github.io/PeekingDuck-projects/pkd/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>Pkd - Hongnan G. PeekingDuck Projects</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#source-code-tracing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Hongnan G. PeekingDuck Projects" class="md-header__button md-logo" aria-label="Hongnan G. PeekingDuck Projects" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hongnan G. PeekingDuck Projects
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pkd
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Hongnan G. PeekingDuck Projects" class="md-nav__button md-logo" aria-label="Hongnan G. PeekingDuck Projects" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Hongnan G. PeekingDuck Projects
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          PeekingDuck
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="PeekingDuck" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          PeekingDuck
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../workflows/" class="md-nav__link">
        Workflows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../exercise_counter/" class="md-nav__link">
        Exercise Counter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../melanoma_gradcam/" class="md-nav__link">
        Melanoma Prediction with Grad-CAM
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Documentation" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api/exercise_counter_api/" class="md-nav__link">
        Exercise Counter
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#source-code-tracing" class="md-nav__link">
    Source Code Tracing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-abstract-node-class" class="md-nav__link">
    The Abstract Node Class
  </a>
  
    <nav class="md-nav" aria-label="The Abstract Node Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#abc-class" class="md-nav__link">
    ABC Class
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-run-method" class="md-nav__link">
    The Run Method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    Problems
  </a>
  
    <nav class="md-nav" aria-label="Problems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chaining-yolo-and-posenet" class="md-nav__link">
    Chaining Yolo and Posenet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>Pkd</h1>

<h2 id="source-code-tracing">Source Code Tracing</h2>
<ul>
<li>
<p><code>peekingduck run</code>: If you check <code>entry_points.txt</code>, the entry point is indeed <code>peekingduck</code> pointing to the package <code>peekingduck.cli</code> script. The <code>cli</code> after the colon <code>:</code> means that we will look at the <code>decorator</code> commands <code>@cli.command()</code>.</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">setup.cfg | entry_points.txt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code># https://github.com/aimakerspace/PeekingDuck/blob/dev/setup.cfg
[options.entry_points]
console_scripts =
    peekingduck = peekingduck.cli:cli
</code></pre></div></td></tr></table></div>
Consequently, when <code>peekingduck run</code> is called, it goes through the following files:</p>
</li>
<li>
<p><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">1</span><span class="p">]:</span></code> The decorator <code>@cli.command()</code> is called. No arguments were passed on the command line and therefore the default arguments be taken from <code>@click.option()</code>.</p>
</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">2</span><span class="o">-</span><span class="mi">26</span><span class="p">]:</span></code> The decorator <code>@click.option()</code> takes in various things such as default arguments for the function. For example, the default argument for <code>node_config</code> is defaulted to <code>None</code>.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">27</span><span class="o">-</span><span class="mi">33</span><span class="p">]:</span></code> This is the function that is called when <code>peekingduck run</code> is called. <ul>
<li>Let us check the input arguments here:<ul>
<li><code>config_path</code>: If not provided, it defaults to <code>pipeline_config.yml</code>. The new variable is called <code>pipeline_config_path</code>.</li>
<li><code>log_level</code>: <code>INFO</code> level.</li>
<li><code>node_config</code>: <code>None</code> as no custom arguments provided.</li>
<li><code>num_iter</code>: <code>None</code></li>
<li><code>nodes_parent_dir</code>: Points to <code>src</code>, the folder that was created by default! Override if you want to rename your folder.</li>
</ul>
</li>
</ul>
</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">38</span><span class="o">-</span><span class="mi">46</span><span class="p">]:</span></code> We set <code>pipeline_config_path</code> to <code>Path(config_path)</code>. This variable holds the path to our <code>pipeline_config.yml</code> file.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">49</span><span class="o">-</span><span class="mi">55</span><span class="p">]:</span></code> The <code>Runner</code> class is called, we can trace the code in the <code>peekingduck.runner.py</code>. We will now go to the <code>peekingduck.runner.py</code> file. Note that I highlighted line 54 to set <code>nodes=None</code> for my own clarity purposes.</li>
<li>
<p><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">27</span><span class="o">-</span><span class="mi">34</span><span class="p">]:</span></code> We see that <code>Runner()</code> class takes in the following arguments:</p>
<ul>
<li><code>pipeline_path: Path = None</code></li>
<li><code>config_updates_cli: str = None</code></li>
<li><code>custom_nodes_parent_subdir: str = None</code></li>
<li><code>num_iter: int = None</code></li>
<li><code>nodes: List[AbstractNode] = None</code></li>
</ul>
<p>All of which were passed in to the <code>Runner</code> class in <code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">49</span><span class="o">-</span><span class="mi">55</span><span class="p">]</span></code>.</p>
</li>
<li>
<p><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">41</span><span class="o">-</span><span class="mi">45</span><span class="p">]:</span></code> The <code>Runner()</code> class took in <code>pipeline_path</code>, <code>config_updates_cli</code> and <code>custom_nodes_parent_subdir</code> and thus will go into the <code>elif</code> of the <code>if-elif-else</code> statement.</p>
</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">47</span><span class="o">-</span><span class="mi">51</span><span class="p">]:</span></code> <code>self.node_loader</code> will call <code>DeclarativeLoader</code> which is a helper class to create the final <code>Pipeline &lt;peekingduck.pipeline.pipeline.Pipeline&gt;</code> object. Let us see what it does at a high level. Take note that at this stage we are just <strong>initializing</strong> the the <code>DeclarativeLoader</code> class; consequently, we should look what happens in its <code>__init__</code> method.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">declarative_loader</span><span class="o">.</span><span class="n">DeclarativeLoader</span><span class="p">()</span><span class="o">-</span><span class="n">Lines</span> <span class="mi">53</span><span class="o">-</span><span class="mi">57</span><span class="p">]:</span></code> We take a look at some key attributes and methods of the <code>DeclarativeLoader</code> class.<ul>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">declarative_loader</span><span class="o">.</span><span class="n">DeclarativeLoader</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">33</span><span class="p">]:</span></code> The attribute <code>self.node_list = self._load_node_list(pipeline_path)</code> is instantiated. We take a look at one of the important attributes of the <code>DeclarativeLoader</code> class, <code>node_list</code>. This is a <code>NodeList</code> object (defined in the same file) that has the attribute <code>nodes</code> which gives us the following. This means they loaded all the config in pipeline_config.yml into a list of dict.<ul>
<li><code>self.node_list</code>: It returns <code>NodeList(upgraded_nodes)</code> as a <code>NodeList</code> object, an abstract object defined in <code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">declarative_loader</span><span class="o">.</span><span class="n">DeclarativeLoader</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">214</span><span class="o">-</span><span class="mi">240</span><span class="p">]</span></code>.</li>
<li><code>self.node_list.nodes</code>: List of Dict - basically loads all config from <code>pipeline_config.yml</code> into a list of dict.
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;input.visual&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;https://storage.googleapis.com/reighns/peekingduck/videos/wave.mp4&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;model.yolo&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;v4tiny&quot;</span><span class="p">,</span>
            <span class="s2">&quot;iou_threshold&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;score_threshold&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;detect_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">],</span>
            <span class="s2">&quot;num_classes&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;model.posenet&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;resnet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">224</span><span class="p">},</span>
            <span class="s2">&quot;score_threshold&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;dabble.fps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;custom_nodes.dabble.exercise_counter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;draw.poses&quot;</span><span class="p">,</span>
    <span class="s2">&quot;model.mtcnn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;draw.mosaic_bbox&quot;</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;draw.legend&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;show&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fps&quot;</span><span class="p">]}},</span>
    <span class="s2">&quot;output.screen&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">52</span><span class="p">]:</span></code> Creates <code>self.pipeline</code> which calls the <code>get_pipeline()</code> method in <code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">declarative_loader</span><span class="o">.</span><span class="n">DeclarativeLoader</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">199</span><span class="p">]</span></code>. </li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">declarative_loader</span><span class="o">.</span><span class="n">DeclarativeLoader</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">204</span><span class="p">]:</span></code> <code>instantiated_nodes = self._instantiate_nodes()</code> is where we create all the nodes. I'd imagine the nodes are created by looping over the list of dict just now, and for each node dict in the list, we create the <code>AbstractNode</code> class from it. It may be useful to check what <code>Pipeline</code> contains! Let us hop over to from <code>peekingduck.pipeline.pipeline.Pipeline</code>.</li>
<li>Going into <code>from peekingduck.pipeline.pipeline import Pipeline</code> object, we see that the <code>Pipeline</code> object holds an attribute <code>nodes</code>, which unsurprisingly, refers to a list of <code>AbstractNode</code> object (i.e. <code>List[AbstractNode]</code>).</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">58</span><span class="p">]:</span></code> We are finally back to the last line of the <code>peekingduck.cli.run()</code> function. We call the <code>Runner.run()</code> method.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">78</span><span class="p">]:</span></code> Start of <code>while</code> loop with <code>self.pipeline.terminate</code> as <code>False</code> at first.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">79</span><span class="p">]:</span></code> Loop over <code>self.pipeline.nodes</code>, recall that <code>self.pipeline.nodes</code> is a list of <code>AbstractNode</code> objects.</li>
<li><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">83</span><span class="o">-</span><span class="mi">84</span><span class="p">]:</span></code> Terminating conditions.</li>
<li>
<p><code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">91</span><span class="o">-</span><span class="mi">95</span><span class="p">]:</span></code> Update <code>inputs</code> dict if we can find a <code>key</code> in <code>self.pipeline.data</code>. This part was confusing at first since the first <strong>iteration</strong> the <code>self.pipeline.data</code> is an empty dict. Upon checking, it turns out that the first <code>Node</code> is <code>input.visual</code> which takes in <code>input</code> as <code>None</code> and <code>output</code> as <code>output: ["img", "filename", "pipeline_end", "saved_video_fps"]</code>. Therefore in the first iteration, there won't be any <code>key</code> and thus <code>inputs</code> will be <code>{}</code> but <code>outputs</code> from <code class="highlight"><span class="p">[</span><span class="n">peekingduck</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">()</span><span class="o">-</span><span class="n">Line</span> <span class="mi">103</span><span class="p">]</span></code> will be <code>{"img": ..., "filename": ..., "pipeline_end": ..., "saved_video_fps": ...}</code>. Consequently, <code>self.pipeline.data</code> will update the dictionary <code>inputs</code> with the <code>outputs</code> from the first <code>Node</code>. It will keep chaining on till the last node. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">peekingduck.cli.run()</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--config_path&quot;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s2">&quot;List of nodes to run. None assumes pipeline_config.yml at current working directory&quot;</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--log_level&quot;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Modify log level {&quot;critical&quot;, &quot;error&quot;, &quot;warning&quot;, &quot;info&quot;, &quot;debug&quot;}&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--node_config&quot;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Modify node configs by wrapping desired configs in a JSON string.</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">        Example: --node_config &#39;{&quot;node_name&quot;: {&quot;param_1&quot;: var_1}}&#39;&quot;&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--num_iter&quot;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop pipeline after running this number of iterations&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
    <span class="n">config_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">node_config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">num_iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">nodes_parent_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Runs PeekingDuck&quot;&quot;&quot;</span>

    <span class="n">LoggerSetup</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">curr_dir</span> <span class="o">=</span> <span class="n">_get_cwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">curr_dir</span> <span class="o">/</span> <span class="s2">&quot;pipeline_config.yml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">curr_dir</span> <span class="o">/</span> <span class="s2">&quot;pipeline_config.yml&quot;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">curr_dir</span> <span class="o">/</span> <span class="s2">&quot;run_config.yml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">curr_dir</span> <span class="o">/</span> <span class="s2">&quot;run_config.yml&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_path</span> <span class="o">=</span> <span class="n">curr_dir</span> <span class="o">/</span> <span class="s2">&quot;pipeline_config.yml&quot;</span>
    <span class="n">pipeline_config_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
        <span class="n">pipeline_path</span><span class="o">=</span><span class="n">pipeline_config_path</span><span class="p">,</span>
        <span class="n">config_updates_cli</span><span class="o">=</span><span class="n">node_config</span><span class="p">,</span>
        <span class="n">custom_nodes_parent_subdir</span><span class="o">=</span><span class="n">nodes_parent_dir</span><span class="p">,</span>
        <span class="n">num_iter</span><span class="o">=</span><span class="n">num_iter</span><span class="p">,</span>
<span class="hll">        <span class="n">nodes</span><span class="o">=</span><span class="kc">None</span>
</span>    <span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Startup time = </span><span class="si">{</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">peekingduck.runner.Runner()</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Runner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The runner class for creation of pipeline using declared/given nodes.</span>

<span class="sd">    The runner class uses the provided configurations to setup a node pipeline</span>
<span class="sd">    which is used to run inference.</span>

<span class="sd">    Args:</span>
<span class="sd">        pipeline_path (:obj:`pathlib.Path` | :obj:`None`): If a path to</span>
<span class="sd">            *pipeline_config.yml* is provided, uses</span>
<span class="sd">            :py:class:`DeclarativeLoader &lt;peekingduck.declarative_loader.DeclarativeLoader&gt;`</span>
<span class="sd">            to load the YAML file according to PeekingDuck&#39;s specified schema</span>
<span class="sd">            to obtain the declared nodes that would be sequentially initialized</span>
<span class="sd">            and used to create the pipeline for running inference.</span>
<span class="sd">        config_updates_cli (:obj:`str` | :obj:`None`): Configuration changes</span>
<span class="sd">            passed as part of the CLI command used to modify the node</span>
<span class="sd">            configurations directly from CLI.</span>
<span class="sd">        custom_nodes_parent_subdir (:obj:`str` | :obj:`None`): Relative path to</span>
<span class="sd">            a folder which contains custom nodes that users have created to be</span>
<span class="sd">            used with PeekingDuck. For more information on using custom nodes,</span>
<span class="sd">            please refer to</span>
<span class="sd">            `Getting Started &lt;getting_started/03_custom_nodes.html&gt;`_.</span>
<span class="sd">        num_iter (int): Stop pipeline after running this number of iterations</span>
<span class="sd">        nodes (:obj:`List[AbstractNode]` | :obj:`None`): If a list of nodes is</span>
<span class="sd">            provided, initialize by the node stack directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_updates_cli</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_nodes_parent_subdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AbstractNode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="c1"># instantiated_nodes is created differently when given nodes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">pipeline_path</span>
                <span class="ow">and</span> <span class="n">config_updates_cli</span>
                <span class="ow">and</span> <span class="n">custom_nodes_parent_subdir</span>
            <span class="p">):</span>
                <span class="c1"># create Graph to run</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_loader</span> <span class="o">=</span> <span class="n">DeclarativeLoader</span><span class="p">(</span>
                    <span class="n">pipeline_path</span><span class="p">,</span>
                    <span class="n">config_updates_cli</span><span class="p">,</span>
                    <span class="n">custom_nodes_parent_subdir</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_loader</span><span class="o">.</span><span class="n">get_pipeline</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Arguments error! Pass in either nodes to load directly via &quot;</span>
                    <span class="s2">&quot;Pipeline or pipeline_path, config_updates_cli, and &quot;</span>
                    <span class="s2">&quot;custom_nodes_parent_subdir to load via DeclarativeLoader.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RequirementChecker</span><span class="o">.</span><span class="n">n_update</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RequirementChecker</span><span class="o">.</span><span class="n">n_update</span><span class="si">}</span><span class="s2"> package&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;s&#39;</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">RequirementChecker</span><span class="o">.</span><span class="n">n_update</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> updated. &quot;</span>
                <span class="s2">&quot;Please rerun for the updates to take effect.&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_iter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">num_iter</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_iter</span> <span class="o">=</span> <span class="n">num_iter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run pipeline for </span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2"> iterations&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="sd">&quot;&quot;&quot;execute single or continuous inference&quot;&quot;&quot;</span>
        <span class="n">num_iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">terminate</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># report node setup times at first iteration</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First iteration: setup </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    <span class="n">node_start_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline_end&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">terminate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="s2">&quot;pipeline_end&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span>
                    <span class="p">}</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;optional_inputs&quot;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">optional_inputs</span><span class="p">:</span>
                        <span class="c1"># The nodes will not receive inputs with the optional</span>
                        <span class="c1"># key if it&#39;s not found upstream</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                            <span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="n">outputs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">node_end_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> setup time = </span><span class="si">{</span><span class="n">node_end_time</span> <span class="o">-</span> <span class="n">node_start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span>
                    <span class="p">)</span>
            <span class="n">num_iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_iter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">num_iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_iter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Stopping pipeline after </span><span class="si">{</span><span class="n">num_iter</span><span class="si">}</span><span class="s2"> iterations&quot;</span>
                <span class="p">)</span>
                <span class="k">break</span>

        <span class="c1"># clean up nodes with threads</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.visual&quot;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">release_resources</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeList</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Retrieves run configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (:obj:`Dict`): Run configurations being used by runner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_loader</span><span class="o">.</span><span class="n">node_list</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">peekingduck.declarative_loader.DeclarativeLoader()</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DeclarativeLoader</span><span class="p">:</span>  <span class="c1"># pylint: disable=too-few-public-methods</span>
    <span class="sd">&quot;&quot;&quot;A helper class to create</span>
<span class="sd">    :py:class:`Pipeline &lt;peekingduck.pipeline.pipeline.Pipeline&gt;`.</span>

<span class="sd">    The declarative loader class creates the specified nodes according to any</span>
<span class="sd">    modifications provided in the configs and returns the pipeline needed for</span>
<span class="sd">    inference.</span>

<span class="sd">    Args:</span>
<span class="sd">        pipeline_path (:obj:`pathlib.Path`): Path to a YAML file that</span>
<span class="sd">            declares the node sequence to be used in the pipeline.</span>
<span class="sd">        config_updates_cli (:obj:`str`): Stringified nested dictionaries of</span>
<span class="sd">            configuration changes passed as part of CLI command. Used to modify</span>
<span class="sd">            the node configurations directly from the CLI.</span>
<span class="sd">        custom_nodes_parent_subdir (:obj:`str`): Relative path to parent</span>
<span class="sd">            folder which contains custom nodes that users have created to be</span>
<span class="sd">            used with PeekingDuck. For more information on using custom nodes,</span>
<span class="sd">            please refer to</span>
<span class="sd">            `Getting Started &lt;getting_started/03_custom_nodes.html&gt;`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">config_updates_cli</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">custom_nodes_parent_subdir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkd_base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_loader</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkd_base_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_node_list</span><span class="p">(</span><span class="n">pipeline_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_updates_cli</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">config_updates_cli</span><span class="p">)</span>

        <span class="n">custom_nodes_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_custom_name_from_node_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">custom_nodes_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">custom_nodes_dir</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="n">custom_nodes_parent_subdir</span> <span class="o">/</span> <span class="n">custom_nodes_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_config_loader</span> <span class="o">=</span> <span class="n">ConfigLoader</span><span class="p">(</span><span class="n">custom_nodes_dir</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_nodes_parent_subdir</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">custom_nodes_dir</span> <span class="o">=</span> <span class="n">custom_nodes_dir</span>

    <span class="k">def</span> <span class="nf">_load_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NodeList&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loads a list of nodes from pipeline_path.yml&quot;&quot;&quot;</span>

        <span class="c1"># dotw 2022-03-17: Temporary helper methods</span>
        <span class="k">def</span> <span class="nf">deprecation_warning</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` deprecated, replaced by `input.visual`&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;convert `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` to `input.visual`:</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pipeline_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">node_yml</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">node_yml</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;nodes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline_path</span><span class="si">}</span><span class="s2"> has an invalid structure. &quot;</span>
                <span class="s2">&quot;Missing top-level &#39;nodes&#39; key.&quot;</span>
            <span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pipeline_path</span><span class="si">}</span><span class="s2"> does not contain any nodes!&quot;</span><span class="p">)</span>

        <span class="n">upgraded_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input.live&quot;</span><span class="p">,</span> <span class="s2">&quot;input.recorded&quot;</span><span class="p">]:</span>
                    <span class="n">deprecation_warning</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;input.visual&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="s2">&quot;input.live&quot;</span><span class="p">:</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input.visual&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;input.recorded with no parameters error!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="s2">&quot;input.visual&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;input.live&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">node_config</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;input.live&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;input_source&quot;</span> <span class="ow">in</span> <span class="n">node_config</span><span class="p">:</span>
                        <span class="n">node_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;input_source&quot;</span><span class="p">)</span>
                    <span class="n">node</span><span class="p">[</span><span class="s2">&quot;input.visual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_config</span>
                    <span class="n">deprecation_warning</span><span class="p">(</span><span class="s2">&quot;input.live&quot;</span><span class="p">,</span> <span class="n">node_config</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;input.recorded&quot;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">node_config</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;input.recorded&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;input_dir&quot;</span> <span class="ow">in</span> <span class="n">node_config</span><span class="p">:</span>
                        <span class="n">node_config</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;input_dir&quot;</span><span class="p">)</span>
                    <span class="n">node</span><span class="p">[</span><span class="s2">&quot;input.visual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_config</span>
                    <span class="n">deprecation_warning</span><span class="p">(</span><span class="s2">&quot;input.recorded&quot;</span><span class="p">,</span> <span class="n">node_config</span><span class="p">)</span>
            <span class="n">upgraded_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully loaded pipeline file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NodeList</span><span class="p">(</span><span class="n">upgraded_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_custom_name_from_node_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">custom_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">node_str</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="n">node_type</span> <span class="o">=</span> <span class="n">node_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">node_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PEEKINGDUCK_NODE_TYPES</span><span class="p">:</span>
                <span class="n">custom_name</span> <span class="o">=</span> <span class="n">node_type</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">custom_name</span>

    <span class="k">def</span> <span class="nf">_instantiate_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AbstractNode</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Given a list of imported nodes, instantiate nodes&quot;&quot;&quot;</span>
        <span class="n">instantiated_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">node_str</span><span class="p">,</span> <span class="n">config_updates_yml</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_list</span><span class="p">:</span>
            <span class="n">node_str_split</span> <span class="o">=</span> <span class="n">node_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing </span><span class="si">{</span><span class="n">node_str</span><span class="si">}</span><span class="s2"> node...&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_str_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># convert windows/linux filepath to a module path</span>
                <span class="n">path_to_node</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_nodes_dir</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="n">node_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">node_str_split</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>

                <span class="n">instantiated_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_node</span><span class="p">(</span>
                    <span class="n">path_to_node</span><span class="p">,</span>
                    <span class="n">node_name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">custom_config_loader</span><span class="p">,</span>
                    <span class="n">config_updates_yml</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path_to_node</span> <span class="o">=</span> <span class="s2">&quot;peekingduck.pipeline.nodes.&quot;</span>

                <span class="n">instantiated_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_node</span><span class="p">(</span>
                    <span class="n">path_to_node</span><span class="p">,</span>
                    <span class="n">node_str</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config_loader</span><span class="p">,</span>
                    <span class="n">config_updates_yml</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">instantiated_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instantiated_node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instantiated_nodes</span>

    <span class="k">def</span> <span class="nf">_init_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_to_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config_loader</span><span class="p">:</span> <span class="n">ConfigLoader</span><span class="p">,</span>
        <span class="n">config_updates_yml</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractNode</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Imports node to filepath and initializes node with config.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">path_to_node</span> <span class="o">+</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config_loader</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>

        <span class="c1"># First, override default configs with values from pipeline_config.yml</span>
        <span class="k">if</span> <span class="n">config_updates_yml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config_updates_yml</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>

        <span class="c1"># Second, override configs again with values from cli</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_updates_cli</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_updates_cli</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_config</span><span class="p">(</span>
                    <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_updates_cli</span><span class="p">[</span><span class="n">node_name</span><span class="p">],</span> <span class="n">node_name</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_edit_config</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dict_orig</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">dict_update</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Update value of a nested dictionary of varying depth using recursion&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="n">dict_orig</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_edit_config</span><span class="p">(</span>
                    <span class="n">dict_orig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">value</span><span class="p">,</span> <span class="n">node_name</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_orig</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Config for node </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> does not have the key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;detect_ids&quot;</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">obj_det_change_class_name_to_id</span><span class="p">(</span>
                            <span class="n">node_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>
                        <span class="p">)</span>

                    <span class="n">dict_orig</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Config for node </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2"> is updated to: &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_orig</span>

    <span class="k">def</span> <span class="nf">get_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pipeline</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns a compiled</span>
<span class="sd">        :py:class:`Pipeline &lt;peekingduck.pipeline.pipeline.Pipeline&gt;` for</span>
<span class="sd">        PeekingDuck :py:class:`Runner &lt;peekingduck.runner.Runner&gt;` to execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instantiated_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_nodes</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">instantiated_nodes</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NodeList</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Iterator class to return node string and node configs (if any) from the</span>
<span class="sd">    nodes declared in the run config file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="n">node_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">node_str</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">node_item</span><span class="p">))</span>
            <span class="n">config_updates</span> <span class="o">=</span> <span class="n">node_item</span><span class="p">[</span><span class="n">node_str</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_str</span> <span class="o">=</span> <span class="n">node_item</span>
            <span class="n">config_updates</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">node_str</span><span class="p">,</span> <span class="n">config_updates</span>
</code></pre></div></td></tr></table></div>
</li>
</ul>
<h2 id="the-abstract-node-class">The Abstract Node Class</h2>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">abstract node class</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">peekingduck.pipeline.nodes.node</span> <span class="kn">import</span> <span class="n">AbstractNode</span>


<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">AbstractNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a template class of how to write a node for PeekingDuck.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (:obj:`Dict[str, Any]` | :obj:`None`): Node configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">node_path</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># initialize/load any configs and models here</span>
        <span class="c1"># configs can be called by self.&lt;config_name&gt; e.g. self.filepath</span>
        <span class="c1"># self.logger.info(f&quot;model loaded with configs: config&quot;)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>  <span class="c1"># type: ignore</span>
        <span class="sd">&quot;&quot;&quot;This node does ___.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs (dict): Dictionary with keys &quot;__&quot;, &quot;__&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            outputs (dict): Dictionary with keys &quot;__&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># result = do_something(inputs[&quot;in1&quot;], inputs[&quot;in2&quot;])</span>
        <span class="c1"># outputs = {&quot;out1&quot;: result}</span>
        <span class="c1"># return outputs</span>
</code></pre></div></td></tr></table></div>
<h3 id="abc-class">ABC Class</h3>
<p>Notice that all <strong>custom nodes</strong> are derived from the <code>AbstractNode</code> class from <code>peekingduck.pipeline.nodes.node import AbstractNode</code>. This class is the base class for all custom nodes, as we will soon see.</p>
<ul>
<li>
<p><code>@abstractmethod</code>: This is a decorator which indicates that the method is abstract. More concretely, once a class inherits from <code>AbstractNode</code>, it must implement all the abstract methods. In this case, we need to implement the <code>run</code> method in each custom node.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">abstract method</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;abstract method needed for running node&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This method needs to be implemented&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</li>
</ul>
<h3 id="the-run-method">The Run Method</h3>
<p>As we previously see, the custom nodes are derived from the <code>AbstractNode</code> class. Each custom node must implement the <code>run</code> method. <strong>A brief check tells me that the output of the <code>run</code> method is a dictionary of strings and values.</strong> This is reasonable since we can see from <code>line 133</code> in <code>runner.py</code> that <code>outputs = node.run(inputs)</code>, and <code>outputs</code> is indeed a dictionary of strings and values.</p>
<p>We can also find out what keys the <code>output</code> hold by going to <code>visual.yml</code> and looking at the <code>output</code> key. The logic holds for other default nodes.</p>
<h2 id="problems">Problems</h2>
<h3 id="chaining-yolo-and-posenet">Chaining Yolo and Posenet</h3>
<ul>
<li>I set all thresholds from Yolo and Posenet to be <span class="arithmatex">\(0\)</span> to avoid any quality check on the <code>bboxes</code> so that I can attempt to debug the issue. </li>
<li>The issue turns out to be pretty confusing, when <code>inputs</code> were printed in the <code>dabble.exercise_counter</code>, it turns out that some <code>bboxes</code> were populated but the <code>bbox_scores</code> were not. This should not be the case since a bijective relationship should be formed.</li>
<li>
<p>Upon further digging, here is what I found:</p>
<ul>
<li>Using <code>yolov4tiny</code>, the model did not manage to predict the <code>person</code> class. Thus <code>outputs</code> dict consisting of <code>bboxes, bbox_labels, bbox_scores</code> were empty in the <code>model.yolo</code> portion.</li>
<li>We turn our attention to <code>model.posenet</code>, it turns out that <code>bboxes</code> were again predicted at the Posenet level. This tells us half the story, because <code>bboxes</code> variable is now indeed populated (if Posenet says yes) but <code>bbox_scores</code> variable is still empty.
<div class="highlight"><pre><span></span><code><span class="n">bboxes</span><span class="p">,</span> <span class="n">keypoints</span><span class="p">,</span> <span class="n">keypoint_scores</span><span class="p">,</span> <span class="n">keypoint_conns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">bbox_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;person&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bboxes</span><span class="p">))</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;bboxes&quot;</span><span class="p">:</span> <span class="n">bboxes</span><span class="p">,</span>
    <span class="s2">&quot;keypoints&quot;</span><span class="p">:</span> <span class="n">keypoints</span><span class="p">,</span>
    <span class="s2">&quot;keypoint_scores&quot;</span><span class="p">:</span> <span class="n">keypoint_scores</span><span class="p">,</span>
    <span class="s2">&quot;keypoint_conns&quot;</span><span class="p">:</span> <span class="n">keypoint_conns</span><span class="p">,</span>
    <span class="s2">&quot;bbox_labels&quot;</span><span class="p">:</span> <span class="n">bbox_labels</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
Consequently, when unpacking in the <code>dabble.exercise_counter.py</code>, 
<div class="highlight"><pre><span></span><code><span class="n">img</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;bboxes&quot;</span><span class="p">]</span>

<span class="n">bbox_scores</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;bbox_scores&quot;</span><span class="p">]</span>
<span class="n">keypoints</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;keypoints&quot;</span><span class="p">]</span>
<span class="n">keypoint_scores</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;keypoint_scores&quot;</span><span class="p">]</span>
</code></pre></div>
The <code>bboxes</code> are not empty but <code>bbox_scores</code> is, resulting in error.</li>
<li>A bit more digging into why the <code>bboxes</code> are returned from Posenet. We take a look into <code>self.model = posenet_model.PoseNetModel(self.config)</code> which points to <code>model.posenetv1.posenet_model</code>, and the <code>predict</code> method points to <code>Predictor</code> class in <code>model.posenetv1.postnet_files.predictor</code>. It turns out the <code>bbox</code> is derived from <code>bbox = self._get_bbox_of_one_pose(pose_coords, pose_masks)</code> and these are actually the bounding boxes of the <code>keypoints</code>. So if there are 17 pairs of keypoints, we simply find the max corners of them. (i.e. imagine the keypoints depicts a human skeleton and we enclose them with bboxes). </li>
<li>Something worth noting is in <code>model.posenet</code>, <code>bbox_labels = np.array(["person"] * len(bboxes))</code> was coded to depict <code>person</code>. </li>
<li>Need to add a clause to catch when yolo does not predict anything handling empty <code>bbox_scores</code>. </li>
<li>I believe the purpose of chaining yolo then posenet is to let yolo get the person's bounding box coordinates first, then chain the cropped person to posenet for keypoint predictions... KIV first.</li>
</ul>
</li>
<li>
<p>Created <code>debug</code> file for <code>yolo</code>, <code>posenet</code> and <code>exercise_counter</code> as <code>v4tiny</code> seem to return errors on index out of range.</p>
</li>
<li>Turns out <code>yolov4tiny</code> is not capable of detecting human sometimes, creating empty bboxes and scores, but get overwritten by <code>bboxes</code> found in <code>posenet</code>, which is a bit different from the <code>bboxes</code> in yolo.</li>
<li>In the pipeline where we chain <code>posenet</code> after <code>yolo</code>, I created another debug file before <code>exercise_counter</code> and confirmed that if both <code>yolo</code> and <code>posenet</code> have <code>bbox</code> values, the latter <code>posenet</code> will overwrite the one from <code>yolo</code>. This setting is </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">nodes</span><span class="p">:</span>
<span class="o">-</span> <span class="nb">input</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">reighns</span><span class="o">/</span><span class="n">peekingduck</span><span class="o">/</span><span class="n">videos</span><span class="o">/</span><span class="n">push_ups</span><span class="o">.</span><span class="n">mp4</span>
<span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">yolo</span><span class="p">:</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="s2">&quot;v4&quot;</span> <span class="c1"># &quot;v4tiny&quot;</span>
    <span class="n">iou_threshold</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="n">score_threshold</span><span class="p">:</span> <span class="mf">0.1</span>
    <span class="n">detect_ids</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;person&quot;</span><span class="p">]</span> <span class="c1"># [0]</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">-</span> <span class="n">custom_nodes</span><span class="o">.</span><span class="n">dabble</span><span class="o">.</span><span class="n">debug_yolo</span>
<span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">posenet</span><span class="p">:</span>
    <span class="n">model_type</span><span class="p">:</span> <span class="s2">&quot;resnet&quot;</span>
    <span class="n">resolution</span><span class="p">:</span> <span class="p">{</span><span class="n">height</span><span class="p">:</span> <span class="mi">224</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="mi">224</span><span class="p">}</span>
    <span class="n">score_threshold</span><span class="p">:</span> <span class="mf">0.05</span>
<span class="o">-</span> <span class="n">custom_nodes</span><span class="o">.</span><span class="n">dabble</span><span class="o">.</span><span class="n">debug_posenet</span>
<span class="o">-</span> <span class="n">dabble</span><span class="o">.</span><span class="n">fps</span>
<span class="o">-</span> <span class="n">custom_nodes</span><span class="o">.</span><span class="n">dabble</span><span class="o">.</span><span class="n">debug_exercise_counter</span>
<span class="o">-</span> <span class="n">custom_nodes</span><span class="o">.</span><span class="n">dabble</span><span class="o">.</span><span class="n">exercise_counter</span>
<span class="o">-</span> <span class="n">draw</span><span class="o">.</span><span class="n">poses</span>
<span class="c1"># - model.mtcnn</span>
<span class="c1"># - draw.mosaic_bbox</span>
<span class="o">-</span> <span class="n">draw</span><span class="o">.</span><span class="n">legend</span><span class="p">:</span>
    <span class="n">show</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fps&quot;</span><span class="p">]</span>
<span class="o">-</span> <span class="n">output</span><span class="o">.</span><span class="n">screen</span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="../javascript/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>